#!/bin/bash

# Installation script for bspc-service and bspc-request tools
# Sets up the proactive bspwm management system

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="${HOME}/.local/bin"
CONFIG_DIR="${HOME}/.config/bsp-daemon"
SERVICE_DIR="${HOME}/.config/systemd/user"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

success() { echo -e "${GREEN}✓ $*${NC}"; }
info() { echo -e "${BLUE}ℹ $*${NC}"; }
warn() { echo -e "${YELLOW}⚠ $*${NC}"; }

echo "Installing bspc-service and bspc-request tools..."

# Create directories
info "Creating directories..."
mkdir -p "$INSTALL_DIR" "$CONFIG_DIR" "$SERVICE_DIR"

# Copy executables
info "Installing executables..."
cp "$SCRIPT_DIR/.local/bin/bspc-service" "$INSTALL_DIR/"
cp "$SCRIPT_DIR/.local/bin/bspc-request" "$INSTALL_DIR/"
cp "$SCRIPT_DIR/.local/bin/bspc-manager" "$INSTALL_DIR/" 2>/dev/null || true

chmod +x "$INSTALL_DIR/bspc-service"
chmod +x "$INSTALL_DIR/bspc-request" 
chmod +x "$INSTALL_DIR/bspc-manager" 2>/dev/null || true

success "Executables installed to $INSTALL_DIR"

# Update service file with correct paths
info "Installing systemd user service..."
sed "s|%h/.dotfiles/bsp-daemon/.local/bin/bspc-service|$INSTALL_DIR/bspc-service|g" \
    "$SCRIPT_DIR/.local/share/systemd/user/bspc-service.service" > "$SERVICE_DIR/bspc-service.service"

success "Systemd service file installed"

# Initialize configuration
info "Initializing configuration..."
"$INSTALL_DIR/bspc-service" stop 2>/dev/null || true

# Copy example rules if they don't exist
if [[ ! -f "$CONFIG_DIR/rules.conf" && -f "$SCRIPT_DIR/.config/bsp-daemon/rules.conf" ]]; then
    cp "$SCRIPT_DIR/.config/bsp-daemon/rules.conf" "$CONFIG_DIR/"
    success "Example rules configuration copied"
fi

# Set up PATH if needed
if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
    warn "Add $INSTALL_DIR to your PATH to use bspc-service and bspc-request from anywhere"
    echo "Add this to your shell rc file:"
    echo "export PATH=\"\$PATH:$INSTALL_DIR\""
fi

echo ""
info "Installation completed! Available commands:"
echo "  bspc-service  - Proactive window management daemon"
echo "  bspc-request  - Client for requesting actions"
echo "  bspc-manager  - Original manual tool (if installed)"
echo ""

info "Quick start:"
echo "  # Start the service"
echo "  systemctl --user enable bspc-service"
echo "  systemctl --user start bspc-service"
echo ""
echo "  # Or start manually:"
echo "  bspc-service start"
echo ""
echo "  # Use the client:"
echo "  bspc-request auto-config developer"
echo "  bspc-request workspace mywork code firefox terminal"
echo ""

info "Integration with bspwmrc:"
cat << 'EOF'

Add to your ~/.config/bspwm/bspwmrc:

# Start bspc-service if not running
pgrep -x bspc-service > /dev/null || bspc-service start &

# Load any saved rules
bspc-service status > /dev/null 2>&1 && bspc-request service reload

EOF

info "Integration with sxhkdrc:"
echo "Example keybindings are available in: $SCRIPT_DIR/.local/share/doc/sxhkdrc-bspc-manager"

echo ""
success "Setup complete! The proactive bspwm management system is ready to use."