#!/usr/bin/awk -f

BEGIN {
	if (ARGC == 1 && system("tty -s") == 0) {
        print "error: no input file or pipe provided" > "/dev/stderr"
        exit 1
    }
	
	FS = "|"
	print "["

}

FNR == 1 {
	total_lines = 0
}

{
	total_lines++
}

NR == 1 {
	# Store the header names
	for (i = 1; i <= NF; i++) {
		header[i] = $i
	}
	next
}

{

	printf "{\n"

	for (i = 1; i <= NF; i++) {
		
		$i = escape_json($i)
		# Skip empty fields and values
		
		if (header[i] != "" && $i != "") {
		
			printf "        \"%s\": \"%s\"", header[i], $i
		
			if (i < NF && header[i + 1] != "") {
				printf ",\n"
			} else {
				printf "\n"
			}
		
		}
	}

	if (FNR < NR_TOTAL) {
		printf "},\n"
	} else {
		printf "}\n"
	}

}

FNR = NR_TOTAL {
	printf "]"
}

function escape_json(str) {
	gsub(/\\/, "\\\\", str)   # Escape backslashes
	gsub(/"/, "\\\"", str)    # Escape double quotes
	gsub(/\n/, "\\n", str)    # Escape newlines
	gsub(/\r/, "\\r", str)    # Escape carriage returns
	gsub(/\t/, "\\t", str)    # Escape tabs
	gsub(/\b/, "\\b", str)    # Escape backspaces
	gsub(/\f/, "\\f", str)    # Escape form feeds
	return str
}