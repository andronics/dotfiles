#!/usr/bin/env sh

name=$(basename $0)

# ------------------------------

source $(which _log)
source $(which _singleton)

# ------------------------------

bspc_swallow_ids="/tmp/${name}-ids.tmp"
bspc_swallow_classes="${XDG_CONFIG_HOME}/bspwm/.swallow"
bspc_swallow_terminals="${XDG_CONFIG_HOME}/bspwm/.terminals"

# ------------------------------

_singleton && [[ $? -eq 1 ]] && exit 1

# ------------------------------

[[ ! -f "${bspc_swallow_ids}" ]] && touch "${bspc_swallow_ids}"
[[ ! -f "${bspc_swallow_classes}" ]] && touch "${bspc_swallow_classes}"
[[ ! -f "${bspc_swallow_terminals}" ]] && touch "${bspc_swallow_terminals}"

# ------------------------------

_bspc_swallow() {

	_log_info "subscribing to events"

	bspc subscribe node_add node_remove | while read -r _event; do
		case $(echo "${_event}" | awk '{ print $1 }') in
			node_add)
				_log_info "node_add: $(echo "${_event}" | awk '{print $5 " " $3}')"
				_bspc_swallow_inhale $(echo "${_event}" | awk '{print $5 " " $3}')
				;;
			node_remove)
				_log_info "node_remove: $(echo "${_event}" | awk '{print $4 " " $3}')"
				_bspc_swallow_spit $(echo "${_event}" | awk '{print $4 " " $3}')
				;;
		esac
	done

}

_bspc_swallow_class() {
	_window=$1
	if [ -z "${_window}" ]; then
    	echo ""
  	else
		xprop -id "${_window}" | sed -n '/WM_CLASS\|WM_COMMAND/s/.*"\(.*\)".*/\1/p'
  	fi
}

_bspc_swallow_inhale() {
	
	_swallower=$1
	_desktop=$2

	_swallowing=$(bspc query -N -n last)
	
	if [ "${_desktop}" = $(bspc query -D -n last) ]; then

		_swallower_class=$(_bspc_swallow_class "${_swallower}")
		_swallowing_class=$(_bspc_swallow_class "${_swallowing}")
		
		_log_info "swallower: %s [%s] | swallowing: %s [%s]" "${_swallower}" "${_swallower_class}" "${_swallowing}" "${_swallowing_class}"

		cat ${bspc_swallow_classes} ${bspc_swallow_terminals} | grep "^${_swallower_class}$" && return
		grep "^${_swallower_class}$" ${bspc_swallow_terminals} > /dev/null || return
		
		echo "${_swallower} ${_swallowing}" >> ${bspc_swallow_ids}
		
		bspc node "${_swallowing}" --flag hidden=on
	
	fi
}

_bspc_swallow_spit() {
	
	_spitter=$1
	_desktop=$2

	grep "^${_spitter}" ${bspc_swallow_ids} >> /dev/null || return

	_spitting=$(grep "^${_spitter}" ${bspc_swallow_ids} | head -n1 | awk '{print $2}')
	_spitting_class=$(_bspc_swallow_class "${_spitting}")

	_log_info "spitting: %s | spitting: %s [%s]" "${_spitter}" "${_spitting}" "${_spitting_class}"

	bspc node "${_spitting}" --flag hidden=off
	[[ "$(bspc query -D -n "${_spitting}")" = "${_desktop}" ]] || bspc node "${_spitting}" -d "${_desktop}"

	bspc node "${_spitting}" -f
	sed -i "/^${_spitter}/d" ${bspc_swallow_ids}
}

# ------------------------------

_bspc_swallow "$@"