#!/usr/bin/env zsh

name=$(basename $0)

# ------------------------------

source $(which _log)

# ------------------------------

LOG_LEVEL=4

# ------------------------------

_bsp_external_rules() {

	_window=$1
	_class=$2
	_instance=$3
	_tags=$4

	_random_id=$(tr -dc a-z0-9 </dev/urandom | head -c 10)
	_role=$(_bsp_wininfo "$_window" "WM_WINDOW_ROLE")
	_title=$(xtitle "${_window}")


	log-debug "role(): window: %s  | role: %s" "${_window}" "${_role}"
	log-debug "class(): window: %s  | class: %s" "${_window}" "${_class}"

	# Browser Pass
	[[ "${_role}" == "pop-up" ]]  && [[ "${_instance}" == "crx_naepdomgkenhinolocfifgehidddafch" ]] && {
		[ "$state" ] || echo "state=floating"
		exit
	}

	[[ "${_role}" == "pop-up" ]] && {
		log-info "pop-up(): closing window: ${_window}"
		wmctrl -ic ${_window}
	}

	log-debug "class(): window: %s | class: %s" \
		"${_window}" \
		"${_class}"

	case "${_class}" in
		terminal-draw)
			eval "${_tags}"
			[ "$state" ] || echo "state=floating rectangle=${_instance}"
			;;
		terminal-drop)
			eval "${_tags}"
			[ "$state" ] || echo "state=floating rectangle=5120x1152+0+0 sticky=on follow=on" 
			;;
	esac

}

_bsp_wininfo() {
    _window=$1
    _prop=$2
    value=$(xprop -id "$_window" "$_prop" 2>/dev/null)
    if [[ $? -ne 0 || -z "$value" || "$value" == *"not found"* ]]; then
        echo "n/a"
    else
        echo "$value" | cut -d'"' -f2 || echo "unknown"
    fi
}
# ------------------------------

_bsp_external_rules "$@"
