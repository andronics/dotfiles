#!/bin/bash

# dckr-common - Shared utilities and constants
# This file is sourced by all dckr commands

# Version and constants
declare -r DCKR_VERSION="2.0.0"
declare -r DOCKER_SOCK="/var/run/docker.sock"

# Color codes
declare -r GREEN='\033[0;32m'
declare -r BLUE='\033[0;34m'
declare -r YELLOW='\033[1;33m'
declare -r RED='\033[0;31m'
declare -r CYAN='\033[0;36m'
declare -r MAGENTA='\033[0;35m'
declare -r BOLD='\033[1m'
declare -r NC='\033[0m'

# Paths
DCKR_SCRIPT_DIR=$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")
DCKR_BIN_DIR=$(dirname "$(dirname "$DCKR_SCRIPT_DIR")")/bin
DCKR_MODULE_DIR=$(dirname "$(dirname "$(dirname "$DCKR_SCRIPT_DIR")")")
DCKR_CONFIG_DIR="$HOME/.config/dckr"
DCKR_CACHE_DIR="$DCKR_CONFIG_DIR/cache"
DCKR_AI_AGENTS_DIR="$DCKR_MODULE_DIR/.claude/agents"
DCKR_AI_COMMANDS_DIR="$DCKR_MODULE_DIR/.claude/commands"

# Ensure config directory exists
mkdir -p "$DCKR_CONFIG_DIR" "$DCKR_CACHE_DIR"

# Error handling
dckr_error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit "${2:-1}"
}

dckr_warning() {
    echo -e "${YELLOW}Warning: $1${NC}" >&2
}

dckr_success() {
    echo -e "${GREEN}$1${NC}"
}

dckr_info() {
    echo -e "${BLUE}$1${NC}"
}

dckr_debug() {
    [[ "${DCKR_DEBUG:-}" == "1" ]] && echo -e "${CYAN}Debug: $1${NC}" >&2
}

# Check Docker availability
dckr_check_docker() {
    if [[ ! -S "$DOCKER_SOCK" ]]; then
        dckr_error "Docker socket not found at $DOCKER_SOCK"
    fi
}

# Usage functions
dckr_show_usage() {
    cat << 'EOF'
Docker Stack Manager - Enterprise Edition v2.0.0

Usage: dckr <command> [options]

Commands:
  stack list              List all Docker Compose stacks
  stack <name>            Show detailed information for a stack
  ai <command> [args]     AI-powered stack management and troubleshooting
  config <operation>      Configuration management
  help                    Show this help message
  version                 Show version information

Examples:
  dckr stack list
  dckr stack media
  dckr ai analyze-stack media
  dckr ai debug-stack authentik network
  dckr config get core.docker_sock

AI Features:
  • Intelligent stack analysis and optimization
  • Automated troubleshooting and debugging
  • AI-powered configuration generation
  • Performance monitoring and recommendations

Performance:
  • Optimized with parallel processing
  • Minimal API calls
  • jq support for faster JSON parsing
  • Modular architecture for faster startup

For more information, see: dckr help <command>
EOF
}

dckr_show_version() {
    echo "dckr version $DCKR_VERSION"
    echo "Enterprise Docker Stack Manager"
}

# Utility functions
dckr_check_command() {
    command -v "$1" &>/dev/null
}

# Configuration loading
dckr_load_config() {
    local config_file="$DCKR_CONFIG_DIR/config"
    if [[ -f "$config_file" ]]; then
        source "$config_file"
    fi
}

# Initialize common environment
dckr_init() {
    dckr_check_docker
    dckr_load_config
    dckr_debug "Initialized dckr environment"
}